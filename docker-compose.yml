services:
  pgvector:
    image: pgvector/pgvector:0.7.4-pg16
    container_name: pgvector_db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=ragdb
      - POSTGRES_USER=rag
      - POSTGRES_PASSWORD=ragpass
    ports:
      - "5432:5432"
    volumes:
      - pgvector_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rag -d ragdb"]
      interval: 10s
      timeout: 5s
      retries: 12
  ollama_qwen:
    image: ollama/ollama:latest
    container_name: ollama_qwen
    restart: unless-stopped
    gpus: "all"
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - NVIDIA_VISIBLE_DEVICES=0
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ollama_qwen_data:/root/.ollama
    healthcheck:
      test: ["CMD", "sh", "-lc", "ollama list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12

  ollama_gptoss:
    image: ollama/ollama:latest
    container_name: ollama_gptoss
    restart: unless-stopped
    gpus: "all"
    ports:
      - "11435:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
      - NVIDIA_VISIBLE_DEVICES=1
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    volumes:
      - ollama_gptoss_data:/root/.ollama
    healthcheck:
      test: ["CMD", "sh", "-lc", "ollama list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 12

  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: void_orchestrator
    restart: unless-stopped
    depends_on:
      pgvector:
        condition: service_healthy
      ollama_qwen:
        condition: service_started
      ollama_gptoss:
        condition: service_started
      executor:
        condition: service_started
    environment:
      - QWEN_BASE_URL=http://ollama_qwen:11434
      - QWEN_MODEL_ID=${QWEN_MODEL_ID:-qwen2.5:32b-instruct-q4_K_M}
      - GPTOSS_BASE_URL=http://ollama_gptoss:11434
      - GPTOSS_MODEL_ID=${GPTOSS_MODEL_ID:-gpt-oss:20b}
      - DEFAULT_NUM_CTX=${DEFAULT_NUM_CTX:-4096}
      - DEFAULT_TEMPERATURE=${DEFAULT_TEMPERATURE:-0.3}
      - ENABLE_WEBSEARCH=${ENABLE_WEBSEARCH:-true}
      - SERPAPI_API_KEY
      - EXECUTOR_BASE_URL=http://executor:8081
      - PLANNER_MODEL=${PLANNER_MODEL:-qwen}
      - ENABLE_DEBATE=${ENABLE_DEBATE:-true}
      - MAX_DEBATE_TURNS=${MAX_DEBATE_TURNS:-1}
      - ALLOW_TOOL_EXECUTION=${ALLOW_TOOL_EXECUTION:-true}
      - MCP_HTTP_BRIDGE_URL
      - AUTO_EXECUTE_TOOLS=${AUTO_EXECUTE_TOOLS:-false}
      - POSTGRES_HOST=pgvector
      - POSTGRES_PORT=5432
      - POSTGRES_DB=ragdb
      - POSTGRES_USER=rag
      - POSTGRES_PASSWORD=ragpass
      - EMBEDDING_MODEL_NAME=${EMBEDDING_MODEL_NAME:-sentence-transformers/all-MiniLM-L6-v2}
      - RAG_CACHE_TTL_SEC=${RAG_CACHE_TTL_SEC:-300}
    ports:
      - "8000:8000"
    volumes:
      - ./:/workspace

  executor:
    build:
      context: ./executor
      dockerfile: Dockerfile
    container_name: void_executor
    restart: unless-stopped
    environment:
      - WORKSPACE_DIR=/workspace
      - EXEC_TIMEOUT_SEC=${EXEC_TIMEOUT_SEC:-30}
      - EXEC_MEMORY_MB=${EXEC_MEMORY_MB:-2048}
      - ALLOW_SHELL=${ALLOW_SHELL:-false}
      - SHELL_WHITELIST=${SHELL_WHITELIST:-}
    expose:
      - "8081"
    volumes:
      - ./:/workspace

volumes:
  ollama_qwen_data: {}
  ollama_gptoss_data: {}
  pgvector_data: {}


